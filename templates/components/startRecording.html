{% block startRecording %}

<button id="startRecording" class="bg-blue-500 hover:bg-blue-700 px-4 py-2 rounded font-bold text-white">
    <img src="/assets/microphone.svg" alt="Microphone" class="mx-auto" />
    Start Recording
</button>
<button id="stopRecording" class="bg-blue-500 hover:bg-blue-700 px-4 py-2 rounded font-bold text-white" hidden>
    <img src="/assets/microphone-off.svg" alt="Microphone Off" class="mx-auto" />
    Stop Recording
</button>
<div id="recordingResult" class="m-2">
    <div id="result"></div>
</div>

{% endblock %}

<script>
    // Audio recording
    let mediaRecorder;
    let audioChunks = [];
    
    function getOptions() {
        return {
            outputModeOptions: document.getElementById('outputModeOptions')?.value || '',
            sourceLanguageOptions: document.getElementById('sourceLanguageOptions')?.value || '',
            targetLanguageOptions: document.getElementById('targetLanguageOptions')?.value || ''
        };
    }

    document.getElementById('startRecording').addEventListener('click', async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            
            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const formData = new FormData();
                formData.append('audio_data', audioBlob, 'recording.wav');
                
                const options = getOptions();
                Object.keys(options).forEach(key => formData.append(key, options[key]));

                try {
                    const response = await fetch('/translate', {
                        method: 'POST',
                        body: formData,
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const htmlResponse = await response.text();
                    handleTranslationResult(htmlResponse);
                } catch (error) {
                    console.error('Error:', error);
                    document.getElementById('result').textContent = 'Error occurred during translation.';
                }

                audioChunks = [];
            };

            mediaRecorder.start();
            document.getElementById('startRecording').hidden = true;
            document.getElementById('stopRecording').hidden = false;
        } catch (error) {
            console.error('Error accessing microphone:', error);
            document.getElementById('result').textContent = 'Error accessing microphone.';
        }
    });

    document.getElementById('stopRecording').addEventListener('click', () => {
        mediaRecorder.stop();
        document.getElementById('startRecording').hidden = false;
        document.getElementById('stopRecording').hidden = true;
    });

    function handleTranslationResult(htmlResponse) {
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = htmlResponse;

        // Ensure the textarea is readonly
        const textOutputArea = resultDiv.querySelector('#textOutputArea');
        if (textOutputArea) {
            textOutputArea.readOnly = true;
        }

        // The audio player should already be set up in the HTML response,
        // so we don't need to do anything extra for it.
    }
</script>