{% block recordingContainer %}

<div id="recording-container">
    <button id="startRecording" class="bg-blue-500 hover:bg-blue-700 px-4 py-2 rounded font-bold text-white">
      Start Recording
    </button>
    <button id="stopRecording" class="bg-blue-500 hover:bg-blue-700 px-4 py-2 rounded font-bold text-white" hidden>
      Stop Recording
    </button>
    <div id="recordingResult" class="m-2">
      <div id="audioResults"></div>
    </div>
</div>
{% endblock %}

<script>
    // audio-recorder.js
let mediaRecorder;
let audioChunks = [];

document.getElementById('startRecording').addEventListener('click', startRecording);
document.getElementById('stopRecording').addEventListener('click', stopRecording);

async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    
    mediaRecorder.ondataavailable = (event) => {
      audioChunks.push(event.data);
        console.log("Audio chunk added:", event.data);
    };

    mediaRecorder.start();
    document.getElementById('startRecording').hidden = true;
    document.getElementById('stopRecording').hidden = false;
  } catch (error) {
    console.error('Error accessing microphone:', error);
    document.getElementById('recordingResult').textContent = 'Error accessing microphone.';
  }
}

function stopRecording() {
  mediaRecorder.stop();
  document.getElementById('startRecording').hidden = false;
  document.getElementById('stopRecording').hidden = true;

  mediaRecorder.onstop = async (event) => {
    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
    console.log("Audio blob size:", audioBlob.size, formData.get('audioData').size););
    sendAudioToServer(audioBlob)
    audioChunks = [];

  };
}
let textInputArea = ''
let outputModeOptions = document.getElementById('outputModeOptions') ? document.getElementById('outputModeOptions').value : '';
let sourceLanguageOptions = document.getElementById('sourceLanguageOptions') ? document.getElementById('sourceLanguageOptions').value : '';
let targetLanguageOptions = document.getElementById('targetLanguageOptions') ? document.getElementById('targetLanguageOptions').value : '';
function sendAudioToServer(audioBlob) {
  const formData = new FormData();
  formData.append('audioData', audioBlob, 'static/audio/output.wav');
  formData.append('outputModeOptions', outputModeOptions)
  formData.append('sourceLanguageOptions', sourceLanguageOptions)
  formData.append('targetLanguageOptions', targetLanguageOptions)
 
  

  // Trigger HTMX request
  htmx.ajax('POST', '/translate', {
    target: 'audioResults',
    swap: 'innerHTML',
    values: formData
  });
}
</script>
<script>
    let audioChunks = []
    document.getElementById('startRecording').addEventListener('click', function (event) {
        event.preventDefault();
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            
            mediaRecorder.ondataavailable = (event) => {
              audioChunks.push(event.data);
            };

            mediaRecorder.start();
            document.getElementById('startRecording').hidden = true;
            document.getElementById('stopRecording').hidden = false;
          } catch (error) {
            console.error('Error accessing microphone:', error);
            document.getElementById('recordingResult').textContent = 'Error accessing microphone.';
          }
        }
    }
    let audioBlob
    document.getElementById('stopRecording').addEventListener('click', function(event) {
        mediaRecorder.stop();
        document.getElementById('startRecording').hidden = false;
        document.getElementById('stopRecording').hidden = true;
        mediaRecorder.onstop = async (event) => {
          audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          sendAudioToServer(audioBlob)
          audioChunks = [];
      
        };
      }
    })
    function sendAudioToServer(audioBlob){
        let textInputArea = document.getElementById('textInputArea') ? document.getElementById('textInputArea').value : '';
        let inputModeOptions = document.getElementById('inputModeOptions') ? document.getElementById('inputModeOptions').value : '';
        let outputModeOptions = document.getElementById('outputModeOptions') ? document.getElementById('outputModeOptions').value : '';
        let sourceLanguageOptions = document.getElementById('sourceLanguageOptions') ? document.getElementById('sourceLanguageOptions').value : '';
        let targetLanguageOptions = document.getElementById('targetLanguageOptions') ? document.getElementById('targetLanguageOptions').value : '';

        console.log('Sending translation request:', {
            inputModeOptions,
            outputModeOptions,
            sourceLanguageOptions,
            targetLanguageOptions
        });
        let formData = new FormData()
        formData.append('audioData', audioBlob)

        htmx.ajax('POST', '/uploadAudio', {
            target: '#audioResult',
            swap: 'innerHTML',
            values: {
                textInputArea: textInputArea,
                inputModeOptions: inputModeOptions,
                outputModeOptions: outputModeOptions,
                sourceLanguageOptions: sourceLanguageOptions,
                targetLanguageOptions: targetLanguageOptions
            }
        });
    });
}
</script>